Káº¿ hoáº¡ch triá»ƒn khai Smart Research Queue - Phase 1
TÃ´i chia thÃ nh 4 sprint, má»—i sprint cÃ³ dependency rÃµ rÃ ng. Má»—i task chá»‰ báº¯t Ä‘áº§u khi prerequisite Ä‘Ã£ xong.


Sprint 1: Ná»n mÃ³ng (Storage + Enricher)
  KhÃ´ng phá»¥ thuá»™c gÃ¬ â†’ cÃ³ thá»ƒ báº¯t Ä‘áº§u ngay
     â”‚
     â–¼
Sprint 2: Logic (Grouper + Export Pipeline + Wire vÃ o floating button)  
  Phá»¥ thuá»™c Sprint 1
     â”‚
     â–¼
Sprint 3: UI (Widget + Review Modal + Sidepanel mount)
  Phá»¥ thuá»™c Sprint 2
     â”‚
     â–¼
Sprint 4: NLM Banner + Cleanup + Polish
  Phá»¥ thuá»™c Sprint 3
Sprint 1: Ná»n mÃ³ng
Má»¥c tiÃªu: Card táº¡o Ä‘Æ°á»£c vÃ  lÆ°u Ä‘Æ°á»£c vÃ o storage. ChÆ°a cÃ³ UI, chÆ°a cÃ³ export.

Task 1.1: ThÃªm storage key + settings vÃ o bridge/types.js

File:    bridge/types.js
DÃ²ng:    Sau dÃ²ng 9 (NLM_IDEA_COOLDOWN_KEY)
Thay Ä‘á»•i: ThÃªm constant + má»Ÿ rá»™ng DEFAULT_NLM_SETTINGS
Cá»¥ thá»ƒ thÃªm:


export const SRQ_CARDS_KEY = "atom_srq_cards_v1";
export const SRQ_MAX_CARDS = 200;
VÃ  thÃªm vÃ o DEFAULT_NLM_SETTINGS (dÃ²ng 15-24):


srqEnabled: true,
srqAutoEnrich: true,
srqShowSidepanelWidget: true,
srqShowNlmBanner: true,
srqMaxCardsPerBatch: 20,
srqStaleCardDays: 14,
srqNotifyThreshold: 3
Kiá»ƒm tra: Import SRQ_CARDS_KEY tá»« types.js khÃ´ng lá»—i.

Task 1.2: Táº¡o storage/srq_store.js - Card CRUD

File má»›i: storage/srq_store.js
Phá»¥ thuá»™c: Task 1.1 (cáº§n SRQ_CARDS_KEY, SRQ_MAX_CARDS)
~150 dÃ²ng code
Module nÃ y cáº§n export:

Function	Input	Output	Ghi chÃº
loadCards()	-	ResearchCard[]	Äá»c tá»« chrome.storage.local
saveCards(cards)	ResearchCard[]	void	Ghi vÃ o storage
addCard(card)	ResearchCard	ResearchCard	Append + FIFO evict náº¿u >= 200
updateCard(cardId, patch)	string, Object	ResearchCard	Merge patch vÃ o card
updateCardStatus(cardId, status)	string, string	ResearchCard	Shortcut cho status update
getCardsByStatus(status)	string	ResearchCard[]	Filter theo status
getCardsByTopicKey(topicKey)	string	ResearchCard[]	Filter theo topicKey
getPendingCards()	-	ResearchCard[]	status = "pending_review"
dismissCard(cardId)	string	void	status â†’ "dismissed"
cleanupStaleCards(maxAgeDays)	number	number	XÃ³a cards cÅ©, return count
getCardStats()	-	{pending, approved, exported, dismissed, total}	Äáº¿m theo status
FIFO logic quan trá»ng:


Khi cards.length >= 200:
  1. TÃ¬m cards cÃ³ status "exported" hoáº·c "dismissed"
  2. Sáº¯p xáº¿p theo createdAt tÄƒng dáº§n (cÅ© nháº¥t trÆ°á»›c)
  3. XÃ³a card cÅ© nháº¥t cho Ä‘áº¿n khi < 200
  4. KHÃ”NG BAO GIá»œ xÃ³a cards "pending_review" hoáº·c "approved"
Kiá»ƒm tra: Viáº¿t test thá»§ cÃ´ng trong DevTools console:


// Táº¡o 1 card, load láº¡i, kiá»ƒm tra cÃ²n card
await srqStore.addCard({cardId: "test_1", status: "pending_review", ...});
const cards = await srqStore.loadCards();
console.assert(cards.length === 1);
Task 1.3: Táº¡o services/srq_enricher.js - Táº¡o card + lÃ m giÃ u

File má»›i: services/srq_enricher.js
Phá»¥ thuá»™c: Task 1.2 (cáº§n srq_store), topic_extractor (cÃ³ sáºµn), privacy_guard (cÃ³ sáºµn)
~120 dÃ²ng code
Cáº§n xá»­ lÃ½ 1 váº¥n Ä‘á»: deriveReadingMode() trong bridge_service.js:37-60 lÃ  unexported function bÃªn trong ES module. Hai cÃ¡ch:

CÃ¡ch A (khuyáº¿n nghá»‹): Replicate logic trong srq_enricher (chá»‰ ~15 dÃ²ng):


function deriveReadingMode(captureData) {
    const command = (captureData.command || "").toLowerCase();
    if (command.includes("critique") || command.includes("quiz") || command.includes("analyze")) return "deep";
    if (command.includes("reference") || command.includes("cite")) return "reference";
    if ((captureData.selectedText || "").length > 500) return "deep";
    return "skim";
}
CÃ¡ch B: Export deriveReadingMode tá»« bridge_service.js â†’ nhÆ°ng pháº£i sá»­a module Ä‘ang cháº¡y, rá»§i ro regression.

Flow createResearchCard(captureData):


captureData vÃ o
  â”‚
  â”œâ”€ Step 1: Kiá»ƒm tra sensitive domain
  â”‚   isSensitiveUrl(url, sensitiveDomains) â†’ náº¿u true: return null
  â”‚
  â”œâ”€ Step 2: Extract topic
  â”‚   extractTopic({title, selection, tags, domain, tagsSource})
  â”‚   â†’ topicKey, topicLabel, topicSource, confidence, keywords
  â”‚
  â”œâ”€ Step 3: Derive reading mode
  â”‚   deriveReadingMode(captureData) â†’ "skim"|"deep"|"reference"|"reread"
  â”‚
  â”œâ”€ Step 4: Check PII
  â”‚   containsPii(selectedText) â†’ náº¿u true: flag card.piiWarning = true
  â”‚
  â”œâ”€ Step 5: Build card object (29 fields)
  â”‚
  â”œâ”€ Step 6: Save â†’ srq_store.addCard(card)
  â”‚
  â”œâ”€ Step 7: Trigger enrichCardAsync(cardId) (non-blocking)
  â”‚
  â””â”€ Return card
Flow enrichCardAsync(cardId) (cháº¡y sau, khÃ´ng block UI):


Load card tá»« store
  â”‚
  â”œâ”€ Gá»i routeTopic() â†’ tÃ¬m suggestedNotebook
  â”‚   Náº¿u decision === "use_existing" â†’ card.suggestedNotebook = bestMatch.notebookRef
  â”‚
  â”œâ”€ Gá»­i message "srq_find_related" â†’ background â†’ related_memory
  â”‚   Nháº­n relatedSessions[{sessionId, title, similarity}]
  â”‚   Filter: similarity >= 0.7, max 3
  â”‚
  â””â”€ updateCard(cardId, { suggestedNotebook, relatedSessions })
Kiá»ƒm tra: Gá»i createResearchCard({url, title, domain, selectedText}) â†’ card Ä‘Æ°á»£c táº¡o vá»›i topicKey, readingMode Ä‘Ãºng.

Task 1.4: ThÃªm SRQ message handlers vÃ o background.js

File:    background.js
DÃ²ng:    Sau block message handler cuá»‘i cÃ¹ng (khoáº£ng dÃ²ng 5007+)
Thay Ä‘á»•i: ThÃªm import + message handlers
Import thÃªm á»Ÿ Ä‘áº§u file (sau dÃ²ng 24):


import { addCard, getCardStats, getCardsByTopicKey, updateCard, 
         updateCardStatus, dismissCard, getPendingCards, 
         cleanupStaleCards } from './storage/srq_store.js';
import { createResearchCard, enrichCardAsync } from './services/srq_enricher.js';
ThÃªm handlers theo pattern hiá»‡n táº¡i (if (request?.type === "...")):


// SRQ handlers
if (request?.type === "SRQ_CREATE_CARD") {
    createResearchCard(request.payload)
        .then(card => sendResponse({ ok: true, card }))
        .catch(err => sendResponse({ ok: false, error: err.message }));
    return true;
}

if (request?.type === "SRQ_GET_PENDING_COUNT") {
    getCardStats()
        .then(stats => sendResponse({ ok: true, stats }))
        .catch(err => sendResponse({ ok: false, error: err.message }));
    return true;
}

if (request?.type === "SRQ_GET_CARDS") {
    getPendingCards()
        .then(cards => sendResponse({ ok: true, cards }))
        .catch(err => sendResponse({ ok: false, error: err.message }));
    return true;
}

if (request?.type === "SRQ_UPDATE_CARD") {
    updateCard(request.cardId, request.patch)
        .then(card => sendResponse({ ok: true, card }))
        .catch(err => sendResponse({ ok: false, error: err.message }));
    return true;
}

if (request?.type === "SRQ_DISMISS_CARD") {
    dismissCard(request.cardId)
        .then(() => sendResponse({ ok: true }))
        .catch(err => sendResponse({ ok: false, error: err.message }));
    return true;
}
Pattern quan trá»ng: background.js dÃ¹ng request?.type === "..." (KHÃ”NG PHáº¢I request.action). Táº¥t cáº£ SRQ messages Ä‘á»u prefix SRQ_ Ä‘á»ƒ dá»… phÃ¢n biá»‡t.

Kiá»ƒm tra: Tá»« DevTools console cá»§a báº¥t ká»³ tab nÃ o:


chrome.runtime.sendMessage({type: "SRQ_GET_PENDING_COUNT"}, r => console.log(r));
// â†’ { ok: true, stats: { pending: 0, approved: 0, ... } }
Sprint 1 Done Checkpoint
Sau Sprint 1, báº¡n cÃ³ thá»ƒ test toÃ n bá»™ data layer mÃ  chÆ°a cáº§n UI:


// Test tá»« DevTools console:

// 1. Táº¡o card
chrome.runtime.sendMessage({
    type: "SRQ_CREATE_CARD",
    payload: {
        url: "https://arxiv.org/abs/2301.00001",
        title: "Sparse Attention Mechanisms",
        domain: "arxiv.org",
        selectedText: "Sparse attention reduces quadratic complexity...",
        tags: ["ai", "attention"],
        tagsSource: "user"
    }
}, r => console.log("Card created:", r));

// 2. Kiá»ƒm tra count
chrome.runtime.sendMessage({type: "SRQ_GET_PENDING_COUNT"}, r => console.log(r));

// 3. Load cards
chrome.runtime.sendMessage({type: "SRQ_GET_CARDS"}, r => console.log(r));
Sprint 2: Logic
Má»¥c tiÃªu: Cards tá»± gom batch, export pipeline hoáº¡t Ä‘á»™ng, floating button táº¡o card.

Task 2.1: Táº¡o services/srq_grouper.js

File má»›i: services/srq_grouper.js
Phá»¥ thuá»™c: Task 1.2 (srq_store)
~100 dÃ²ng code
Export:

Function	MÃ´ táº£
computeBatches(cards)	Group cards by topicKey â†’ ResearchBatch[]
computeBatchPriority(batch)	Score 0-100 dá»±a trÃªn readingMode + size + age
getBatchesForExport()	Load pending cards â†’ computeBatches â†’ sort by priority
Priority formula (Ä‘Ã£ cÃ³ trong spec):


Priority = (modeWeight Ã— 40) + (sizeWeight Ã— 30) + (ageWeight Ã— 30)
Kiá»ƒm tra: Táº¡o 5 cards vá»›i 2 topicKey khÃ¡c nhau â†’ getBatchesForExport() tráº£ 2 batches, sorted by priority.

Task 2.2: ThÃªm batch export + grouper handlers vÃ o background.js

File:    background.js
Thay Ä‘á»•i: ThÃªm import srq_grouper + handlers má»›i
ThÃªm handlers:


if (request?.type === "SRQ_GET_BATCHES") {
    getBatchesForExport()
        .then(batches => sendResponse({ ok: true, batches }))
        .catch(err => sendResponse({ ok: false, error: err.message }));
    return true;
}

if (request?.type === "SRQ_DISMISS_BATCH") {
    // Dismiss táº¥t cáº£ cards cÃ¹ng topicKey
    const cards = await getCardsByTopicKey(request.topicKey);
    for (const card of cards) {
        await updateCardStatus(card.cardId, "dismissed");
    }
    sendResponse({ ok: true, dismissed: cards.length });
    return true;
}

if (request?.type === "SRQ_EXPORT_BATCH") {
    handleBatchExport(request.topicKey, request.notebookRef)
        .then(result => sendResponse({ ok: true, ...result }))
        .catch(err => sendResponse({ ok: false, error: err.message }));
    return true;
}
handleBatchExport flow (function má»›i trong background.js):


async function handleBatchExport(topicKey, notebookRef) {
    1. Load cards theo topicKey, filter status "pending_review" | "approved"
    2. Cho má»—i card:
       a. formatAtomClip() â†’ text (dÃ¹ng clip_format.js CÃ“ Sáº´N)
       b. buildDedupeKey() â†’ check isDedupeHit() (dÃ¹ng export_queue.js CÃ“ Sáº´N)
       c. Náº¿u khÃ´ng trÃ¹ng: createExportJob() â†’ enqueueExportJob()
       d. updateCardStatus(cardId, "exported")
    3. Return { exported: count, skipped: dedupeHits }
}
ÄÃ¢y lÃ  pháº§n ná»‘i SRQ vÃ o existing export pipeline - khÃ´ng viáº¿t export logic má»›i, chá»‰ feed data vÃ o export_queue.js vÃ  clip_format.js Ä‘Ã£ cÃ³.

Kiá»ƒm tra: Gá»i SRQ_EXPORT_BATCH â†’ kiá»ƒm tra export_queue cÃ³ job má»›i, card status chuyá»ƒn "exported".

Task 2.3: Wire nlm_floating_button.js â†’ SRQ

File:    bridge/nlm_floating_button.js
Thay Ä‘á»•i: ~10 dÃ²ng, thÃªm vÃ o cuá»‘i export handler
TÃ¬m chá»— sau khi bundle Ä‘Æ°á»£c táº¡o vÃ  export Ä‘Ã£ trigger (search "sendMessage" trong file nÃ y), thÃªm:


// SRQ: Create research card (fire-and-forget, parallel with existing export)
try {
    chrome.runtime.sendMessage({
        type: "SRQ_CREATE_CARD",
        payload: {
            url: window.location.href,
            title: document.title,
            domain: window.location.hostname,
            selectedText: selection,
            viewportExcerpt: viewportExcerpt || "",
            tags: tags || [],
            tagsSource: tagsSource || "ai",
            command: command || "",
            atomicThought: atomicThought || "",
            refinedInsight: refinedInsight || ""
        }
    });
} catch (e) {
    // Silent fail - SRQ is supplementary
}
Quan trá»ng: fire-and-forget - khÃ´ng await, khÃ´ng callback. Existing export flow khÃ´ng bá»‹ áº£nh hÆ°á»Ÿng. SRQ cháº¡y song song.

Kiá»ƒm tra: Highlight text trÃªn báº¥t ká»³ trang â†’ click floating button â†’ kiá»ƒm tra SRQ_GET_PENDING_COUNT tÄƒng lÃªn 1.

Task 2.4: Test end-to-end data flow

Test thá»§ cÃ´ng:
  1. Má»Ÿ 3 trang khÃ¡c nhau:
     - arxiv.org (paper AI)
     - arxiv.org (paper AI khÃ¡c)
     - seriouseats.com (recipe)
  2. Highlight + click floating button trÃªn má»—i trang
  3. Gá»i SRQ_GET_BATCHES â†’ expect 2 batches (arxiv batch + cooking batch)
  4. Gá»i SRQ_EXPORT_BATCH cho arxiv batch â†’ expect 2 cards exported
  5. Kiá»ƒm tra export_queue cÃ³ 2 jobs má»›i
  6. Gá»i SRQ_GET_PENDING_COUNT â†’ pending giáº£m cÃ²n 1 (cooking card)
Sprint 2 Done Checkpoint
Sau Sprint 2, toÃ n bá»™ pipeline data hoáº¡t Ä‘á»™ng end-to-end nhÆ°ng chÆ°a cÃ³ UI. Má»i thá»© test Ä‘Æ°á»£c qua DevTools console.

Sprint 3: UI
Má»¥c tiÃªu: Sidepanel widget hiá»ƒn thá»‹ batches, review modal hoáº¡t Ä‘á»™ng.

Task 3.1: Táº¡o styles/srq.css.js

File má»›i: styles/srq.css.js
~120 dÃ²ng
Pattern: Giá»‘ng styles/micro_closure.css.js (inject CSS via JS)
CSS-in-JS pattern Ä‘Ã£ dÃ¹ng trong project:


(function() {
    const style = document.createElement('style');
    style.textContent = `
        .srq-widget { ... }
        .srq-batch { ... }
        .srq-review-modal { ... }
    `;
    document.head.appendChild(style);
})();
DÃ¹ng design tokens Ä‘Ã£ cÃ³: --atom-green-primary, --atom-bg-surface, etc.
ThÃªm 4 mode colors má»›i: --srq-mode-deep, --srq-mode-skim, --srq-mode-reference, --srq-mode-reread.

Task 3.2: Táº¡o ui/components/srq_widget.js - Widget + Review Modal

File má»›i: ui/components/srq_widget.js
Phá»¥ thuá»™c: Task 3.1 (CSS), Task 2.1-2.2 (grouper + handlers)
~250 dÃ²ng - file lá»›n nháº¥t cá»§a SRQ
Pattern: IIFE giá»‘ng ui/components/mode_selector.js, primer.js, etc.
Chia thÃ nh 3 pháº§n trong file:

Pháº§n A: Widget render (~80 dÃ²ng)


SRQWidget.create(batches) â†’ DOM element

  Náº¿u batches.length === 0 â†’ return null (khÃ´ng hiá»‡n gÃ¬)
  
  Náº¿u batches.length > 0:
    Render collapsed state:
      [ğŸ“‹ Research Queue] [badge: 4] [â–¼]
    
    Click â–¼ â†’ expand:
      Cho má»—i batch â†’ render batch card:
        [topicLabel] [count] [mode pills]
        [â†’ suggestedNotebook] [confidence%]
        [Export All] [Review] [âœ•]
Pháº§n B: Review Modal (~120 dÃ²ng)


SRQWidget.openReview(batch) â†’ Modal overlay

  Header: "Review: {topicLabel} ({count} clips)"
  
  Cho má»—i card trong batch:
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ selectedText (truncated 100 char) â”‚
    â”‚ domain Â· timeago                  â”‚
    â”‚ ğŸ’¡ atomicThought (náº¿u cÃ³)        â”‚
    â”‚ ğŸ”— relatedSessions (náº¿u cÃ³)      â”‚
    â”‚ âš ï¸ PII warning (náº¿u cÃ³)          â”‚
    â”‚ [âœ“ Export] [âœ• Skip] [âœ Edit]     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  
  Footer:
    Target notebook: [dropdown]
    [Export Selected (n)] [Cancel]
Pháº§n C: Event handlers (~50 dÃ²ng)


Export All â†’ sendMessage(SRQ_EXPORT_BATCH)
Dismiss batch â†’ sendMessage(SRQ_DISMISS_BATCH)  
Skip card â†’ sendMessage(SRQ_DISMISS_CARD)
Edit card â†’ show inline editor for userNote + userTags
Change notebook â†’ update suggestedNotebook cho táº¥t cáº£ cards
Task 3.3: Mount vÃ o sidepanel.html + sidepanel.js
sidepanel.html - thÃªm 2 thá»©:

Container div (sau dÃ²ng 3574, trÆ°á»›c quick-actions):

<div id="srq-widget-container" role="region" aria-label="Research Queue"></div>
Script tag (sau dÃ²ng 3894, trÆ°á»›c sidepanel.js):

<script src="styles/srq.css.js"></script>
<script src="ui/components/srq_widget.js"></script>
sidepanel.js - thÃªm mount logic (~20 dÃ²ng):

TÃ¬m nÆ¡i initialization xáº£y ra (sau DOM ready), thÃªm:


async function mountSRQWidget() {
    const container = document.getElementById('srq-widget-container');
    if (!container) return;
    
    const response = await chrome.runtime.sendMessage({ type: "SRQ_GET_BATCHES" });
    if (!response?.ok || !response.batches?.length) {
        container.innerHTML = '';
        return;
    }
    
    container.innerHTML = '';
    const widget = window.SRQWidget?.create(response.batches);
    if (widget) container.appendChild(widget);
}

// Mount on load
mountSRQWidget();

// Refresh when cards change
chrome.runtime.onMessage.addListener((msg) => {
    if (msg?.type === "SRQ_CARDS_UPDATED") {
        mountSRQWidget();
    }
});
Task 3.4: i18n strings

File: _locales/en/messages.json  (~15 keys má»›i)
File: _locales/vi/messages.json  (~15 keys má»›i)
Keys Ä‘Ã£ liá»‡t kÃª trong spec Section 10. ThÃªm vÃ o cuá»‘i má»—i file.

Task 3.5: Broadcast notification khi card thay Ä‘á»•i
Trong background.js, sau má»—i SRQ handler thÃ nh cÃ´ng, broadcast cho sidepanel:


// Sau createResearchCard thÃ nh cÃ´ng:
chrome.runtime.sendMessage({ type: "SRQ_CARDS_UPDATED" }).catch(() => {});

// Sau dismiss/export thÃ nh cÃ´ng:
chrome.runtime.sendMessage({ type: "SRQ_CARDS_UPDATED" }).catch(() => {});
Sidepanel listener (Task 3.3) sáº½ báº¯t message nÃ y vÃ  refresh widget.

Sprint 3 Done Checkpoint
Sau Sprint 3:

Sidepanel hiá»ƒn thá»‹ widget vá»›i batches
Click "Review" má»Ÿ modal xem chi tiáº¿t cards
Click "Export All" trigger batch export
Click "âœ•" dismiss batch
Widget tá»± refresh khi card thay Ä‘á»•i
Sprint 4: Polish
Task 4.1: NLM Page Banner

File:    bridge/nlm_passive_learning.js
Thay Ä‘á»•i: ~50 dÃ²ng
ThÃªm vÃ o cuá»‘i file, sau function hiá»‡n táº¡i:


// SRQ Banner
async function checkAndShowSRQBanner() {
    const response = await chrome.runtime.sendMessage({ type: "SRQ_GET_PENDING_COUNT" });
    if (!response?.ok || response.stats.pending === 0) return;
    
    // Kiá»ƒm tra cooldown (30 phÃºt)
    const lastDismiss = sessionStorage.getItem("srq_banner_dismiss");
    if (lastDismiss && Date.now() - Number(lastDismiss) < 30 * 60 * 1000) return;
    
    // Inject banner
    const banner = document.createElement('div');
    banner.className = 'atom-srq-nlm-banner';
    banner.innerHTML = `
        ğŸ“‹ ATOM: ${response.stats.pending} research clips ready to export
        <button id="atom-srq-export-current">Export All to Current Notebook</button>
        <button id="atom-srq-open-sidepanel">Open in Sidepanel</button>
        <button id="atom-srq-dismiss-banner">âœ•</button>
    `;
    document.body.prepend(banner);
    
    // Event handlers
    document.getElementById('atom-srq-export-current').onclick = () => { ... };
    document.getElementById('atom-srq-open-sidepanel').onclick = () => {
        chrome.runtime.sendMessage({ type: "ATOM_OPEN_SIDEPANEL" });
    };
    document.getElementById('atom-srq-dismiss-banner').onclick = () => {
        banner.remove();
        sessionStorage.setItem("srq_banner_dismiss", Date.now());
    };
}

// Delay check (chá» NLM load xong)
setTimeout(checkAndShowSRQBanner, CONFIG.INITIAL_DELAY + 1000);
Task 4.2: Stale card cleanup alarm

File:    background.js
Thay Ä‘á»•i: ~15 dÃ²ng
ThÃªm vÃ o nÆ¡i register alarms:


chrome.alarms.create("atom_srq_cleanup", { periodInMinutes: 720 });
Trong alarm handler (tÃ¬m chrome.alarms.onAlarm):


if (alarm.name === "atom_srq_cleanup") {
    const settings = await loadNlmSettings();
    const removed = await cleanupStaleCards(settings.srqStaleCardDays || 14);
    if (removed > 0) console.log(`[ATOM SRQ] Cleaned ${removed} stale cards`);
}
Task 4.3: Update manifest.json

File:    manifest.json
Thay Ä‘á»•i: ThÃªm file má»›i vÃ o web_accessible_resources
ThÃªm vÃ o web_accessible_resources[0].resources:


"styles/srq.css.js",
"ui/components/srq_widget.js"
KhÃ´ng cáº§n thÃªm permissions má»›i - táº¥t cáº£ dÃ¹ng storage (Ä‘Ã£ cÃ³) vÃ  chrome.runtime.sendMessage (khÃ´ng cáº§n permission).

Task 4.4: Edge case testing
Test Case	Expected
0 cards pending	Widget áº©n, banner khÃ´ng hiá»‡n
1 card pending	Widget hiá»‡n, badge = 1
200 cards â†’ thÃªm 1	FIFO xÃ³a card exported/dismissed cÅ© nháº¥t
Card cÃ³ PII	Review modal hiá»‡n warning
Sensitive domain (bank)	Card khÃ´ng táº¡o
NotebookLM Ä‘Ã³ng	Export vÃ o queue, badge hiá»‡n trÃªn icon
Offline	Export button disabled
srqEnabled = false	KhÃ´ng táº¡o card, widget áº©n
TrÃ¹ng card (dedupe)	export_queue skip, khÃ´ng táº¡o job duplicate
TÃ³m táº¯t toÃ n bá»™

Sprint 1 (Ná»n mÃ³ng):          Sprint 2 (Logic):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1.1 types.js keys    â”‚      â”‚ 2.1 srq_grouper.js   â”‚
â”‚ 1.2 srq_store.js     â”‚â”€â”€â”€â”€â”€â†’â”‚ 2.2 background exportâ”‚
â”‚ 1.3 srq_enricher.js  â”‚      â”‚ 2.3 floating button   â”‚
â”‚ 1.4 background msgs  â”‚      â”‚ 2.4 E2E data test    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
Sprint 4 (Polish):             Sprint 3 (UI):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4.1 NLM banner       â”‚â†â”€â”€â”€â”€â”€â”‚ 3.1 srq.css.js       â”‚
â”‚ 4.2 Cleanup alarm    â”‚      â”‚ 3.2 srq_widget.js    â”‚
â”‚ 4.3 manifest.json    â”‚      â”‚ 3.3 sidepanel mount  â”‚
â”‚ 4.4 Edge case tests  â”‚      â”‚ 3.4 i18n strings     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚ 3.5 Broadcast msgs   â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Files má»›i: 5     |  Files sá»­a: 7     |  Tá»•ng ~740 LOC
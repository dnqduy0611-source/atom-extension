"""Amoisekai â€” Growth Ã— Narrative Orchestration.

Connects growth triggers to narrative beat injection.
When a Unique Skill reaches a growth threshold (Bloom/Aspect/Ultimate),
this module generates narrative beats that inject into the Planner pipeline.

The orchestrator calls `check_and_inject_growth_beats()` per scene,
which returns any growth-related beats to prepend/append to the plan.

Ref: UNIQUE_SKILL_GROWTH_SPEC v1.1 Â§6.5, Â§7.3, Â§11.2
"""

from __future__ import annotations

import logging
from enum import Enum
from typing import TYPE_CHECKING

from pydantic import BaseModel, Field

if TYPE_CHECKING:
    from app.models.player import PlayerState

logger = logging.getLogger(__name__)


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# GROWTH BEAT TYPES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

class GrowthArcType(str, Enum):
    """Type of growth narrative arc."""
    ECHO = "echo"           # 1-scene subtle refinement
    SCAR = "scar"           # 2-scene trauma adaptation
    ASPECT_FORGE = "aspect_forge"  # 3-scene branching arc
    ULTIMATE = "ultimate"   # 3-scene Season Climax arc


class GrowthBeat(BaseModel):
    """A narrative beat generated by growth triggers.

    Injected into the Planner's beat list during chapter planning.
    """
    arc_type: str = ""           # GrowthArcType value
    beat_number: int = 1         # Position within the arc
    total_beats: int = 1         # Total beats in this arc
    scene_type: str = "exploration"  # Scene type for this beat
    title: str = ""              # Beat title for Planner
    description: str = ""        # Beat description for Writer
    priority: str = "medium"     # "medium" | "high" | "critical"
    is_decision_point: bool = False  # Requires player choice
    decision_choices: list[dict] = Field(default_factory=list)  # Choice options
    growth_context: dict = Field(default_factory=dict)  # Extra data for Writer
    writer_instruction: str = ""  # Direct instruction for SceneWriter


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# BLOOM (ECHO/SCAR) BEATS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def build_bloom_beats(
    player: PlayerState,
    bloom_trigger: dict,
) -> list[GrowthBeat]:
    """Build beats for Bloom event (Echo Deepening or Scar Adaptation).

    Echo = 1 scene (subtle, rest/exploration).
    Scar = 2 scenes (trauma reveal + adaptation).
    """
    growth = player.unique_skill_growth
    skill = player.unique_skill
    if not growth or not skill:
        return []

    bloom_path = bloom_trigger.get("bloom_path", "echo")

    if bloom_path == "scar":
        return [
            GrowthBeat(
                arc_type=GrowthArcType.SCAR,
                beat_number=1,
                total_beats=2,
                scene_type="exploration",
                title="Váº¿t ThÆ°Æ¡ng Thá»©c Tá»‰nh",
                description=(
                    f"Unique Skill '{skill.name}' pháº£n á»©ng báº¥t thÆ°á»ng sau tráº­n chiáº¿n. "
                    "Trauma trÆ°á»›c Ä‘Ã¢y Ä‘ang lÃ m skill biáº¿n Ä‘á»•i â€” player cáº£m nháº­n "
                    "sá»©c máº¡nh má»›i nhÆ°ng Ä‘au Ä‘á»›n. MÃ´ táº£ skill Ä‘ang 'thá»Ÿ' theo váº¿t sáº¹o."
                ),
                priority="high",
                writer_instruction=(
                    f"Unique Skill '{skill.name}' Ä‘ang tráº£i qua Scar Adaptation. "
                    "Skill biáº¿n Ä‘á»•i tá»« trauma â€” mÃ´ táº£ quÃ¡ trÃ¬nh Ä‘au Ä‘á»›n nhÆ°ng máº¡nh máº½ hÆ¡n. "
                    "ÄÃ¢y KHÃ”NG pháº£i tiáº¿n hÃ³a bÃ¬nh thÆ°á»ng â€” Ä‘Ã¢y lÃ  sáº¹o hÃ³a thÃ nh sá»©c máº¡nh."
                ),
                growth_context={
                    "event": "scar_bloom",
                    "bloom_path": "scar",
                    "skill_name": skill.name,
                    "scar_type": getattr(growth, "scar_type", ""),
                },
            ),
            GrowthBeat(
                arc_type=GrowthArcType.SCAR,
                beat_number=2,
                total_beats=2,
                scene_type="exploration",
                title="Sáº¹o ThÃ nh GiÃ¡p",
                description=(
                    f"Skill '{skill.name}' hoÃ n thÃ nh Scar Adaptation. "
                    "Váº¿t thÆ°Æ¡ng trá»Ÿ thÃ nh pháº§n cá»‘t lÃµi. "
                    "Player cháº¥p nháº­n trauma â†’ skill tiáº¿n hÃ³a."
                ),
                priority="high",
                writer_instruction=(
                    f"Bloom hoÃ n thÃ nh via Scar path. '{skill.name}' giá» mang dáº¥u áº¥n "
                    "cá»§a tráº£i nghiá»‡m Ä‘au thÆ°Æ¡ng. MÃ´ táº£ cinematic moment khi skill 'cháº¥p nháº­n váº¿t sáº¹o'."
                ),
                growth_context={
                    "event": "scar_bloom_complete",
                    "bloom_path": "scar",
                    "skill_name": skill.name,
                },
            ),
        ]

    # Echo Deepening â€” 1 scene, subtle
    return [
        GrowthBeat(
            arc_type=GrowthArcType.ECHO,
            beat_number=1,
            total_beats=1,
            scene_type="rest",
            title="Tiáº¿ng Vá»ng SÃ¢u",
            description=(
                f"Unique Skill '{skill.name}' pháº£n Ã¡nh identity chá»§ nhÃ¢n rÃµ hÆ¡n. "
                "Trong khoáº£nh kháº¯c yÃªn tÄ©nh, player nháº­n ra skill Ä‘ang "
                "'lá»›n lÃªn' cÃ¹ng mÃ¬nh. MÃ´ táº£ subtle refinement â€” khÃ´ng flashy."
            ),
            priority="medium",
            writer_instruction=(
                f"Echo Deepening cho '{skill.name}'. Skill tinh chá»‰nh theo identity â€” "
                "mÃ´ táº£ subtle moment khi player nháº­n ra skill 'hiá»ƒu' mÃ¬nh hÆ¡n. "
                "ÄÃ¢y lÃ  growth tá»± nhiÃªn, KHÃ”NG pháº£i power-up."
            ),
            growth_context={
                "event": "echo_bloom",
                "bloom_path": "echo",
                "skill_name": skill.name,
                "echo_coherence_streak": getattr(growth, "echo_coherence_streak", 0),
            },
        ),
    ]


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ASPECT FORGE ARC (3 SCENES)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def build_aspect_forge_beats(
    player: PlayerState,
    aspect_a_name: str = "TÆ°á»ng Minh",
    aspect_a_description: str = "Tháº¥y Táº¤T Cáº¢ dÃ¹ chá»‰ bá» máº·t",
    aspect_b_name: str = "PhÃ¡ Cháº¥p",
    aspect_b_description: str = "Biáº¿t TRIá»†T Äá»‚ dÃ¹ chá»‰ má»™t Ä‘iá»u",
) -> list[GrowthBeat]:
    """Build 3-beat Aspect Forge narrative arc.

    Scene 1: "Skill Run" â€” discovery, skill activating abnormally
    Scene 2: "The Fork" â€” decision point with 3 choices (A / B / Defer)
    Scene 3: "Reborn" â€” resolution, new aspect applied
    """
    skill = player.unique_skill
    if not skill:
        return []

    return [
        # â”€â”€ Scene 1: Skill Run â”€â”€
        GrowthBeat(
            arc_type=GrowthArcType.ASPECT_FORGE,
            beat_number=1,
            total_beats=3,
            scene_type="exploration",
            title="Skill Run",
            description=(
                f"Unique Skill '{skill.name}' kÃ­ch hoáº¡t báº¥t thÆ°á»ng â€” máº¡nh hÆ¡n bÃ¬nh thÆ°á»ng "
                "nhÆ°ng khÃ´ng kiá»ƒm soÃ¡t Ä‘Æ°á»£c. Skill phÃ¡t sÃ¡ng, rung láº¯c, muá»‘n THAY Äá»”I. "
                "Player cáº£m nháº­n skill Ä‘ang á»Ÿ ngÆ°á»¡ng tiáº¿n hÃ³a."
            ),
            priority="critical",
            writer_instruction=(
                f"'{skill.name}' Ä‘ang á»Ÿ ngÆ°á»¡ng Aspect Forge. MÃ´ táº£ skill hoáº¡t Ä‘á»™ng "
                "báº¥t thÆ°á»ng â€” máº¡nh hÆ¡n nhÆ°ng unstable. ÄÃ¢y lÃ  khá»Ÿi Ä‘áº§u cá»§a 3-scene arc. "
                "Táº¡o tension: skill MUá»N tiáº¿n hÃ³a, player chÆ°a sáºµn sÃ ng."
            ),
            growth_context={
                "event": "aspect_forge_start",
                "skill_name": skill.name,
                "arc_position": "1/3",
            },
        ),

        # â”€â”€ Scene 2: The Fork (Decision Point) â”€â”€
        GrowthBeat(
            arc_type=GrowthArcType.ASPECT_FORGE,
            beat_number=2,
            total_beats=3,
            scene_type="exploration",
            title="The Fork",
            description=(
                f"Skill '{skill.name}' buá»™c kÃ­ch hoáº¡t max. Skill 'phÃ¢n nhÃ¡nh' â€” "
                "player tháº¥y 2 vision: má»™t con Ä‘Æ°á»ng rá»™ng má»Ÿ, má»™t con Ä‘Æ°á»ng sÃ¢u hun hÃºt. "
                "DECISION POINT â€” player pháº£i chá»n hÆ°á»›ng tiáº¿n hÃ³a."
            ),
            priority="critical",
            is_decision_point=True,
            decision_choices=[
                {
                    "id": "aspect_a",
                    "text": f"ðŸŒ Chá»n {aspect_a_name} â€” \"{aspect_a_description}\"",
                    "risk_level": 5,
                    "consequence_hint": f"Skill tiáº¿n hÃ³a thÃ nh {aspect_a_name}",
                },
                {
                    "id": "aspect_b",
                    "text": f"ðŸŽ¯ Chá»n {aspect_b_name} â€” \"{aspect_b_description}\"",
                    "risk_level": 5,
                    "consequence_hint": f"Skill tiáº¿n hÃ³a thÃ nh {aspect_b_name}",
                },
                {
                    "id": "aspect_defer",
                    "text": "â¸ï¸ TrÃ¬ hoÃ£n â€” \"Báº¡n chÆ°a sáºµn sÃ ng\"",
                    "risk_level": 2,
                    "consequence_hint": "Aspect Forge hoÃ£n láº¡i 5 chapters",
                },
            ],
            writer_instruction=(
                f"QUYáº¾T Äá»ŠNH Lá»šN: '{skill.name}' Ä‘ang phÃ¢n nhÃ¡nh. "
                f"Vision A â†’ {aspect_a_name}: {aspect_a_description}. "
                f"Vision B â†’ {aspect_b_name}: {aspect_b_description}. "
                "MÃ´ táº£ 2 vision rÃµ rÃ ng, epic, contrasting. "
                "ÄÃ¢y lÃ  permanent choice â€” KHÃ”NG thá»ƒ Ä‘á»•i."
            ),
            growth_context={
                "event": "aspect_forge_fork",
                "skill_name": skill.name,
                "arc_position": "2/3",
                "aspect_a": aspect_a_name,
                "aspect_b": aspect_b_name,
            },
        ),

        # â”€â”€ Scene 3: Reborn â”€â”€
        GrowthBeat(
            arc_type=GrowthArcType.ASPECT_FORGE,
            beat_number=3,
            total_beats=3,
            scene_type="exploration",
            title="Reborn",
            description=(
                f"Skill '{skill.name}' hoÃ n thÃ nh tiáº¿n hÃ³a Aspect. "
                "Cinematic transformation â€” skill má»›i láº§n Ä‘áº§u kÃ­ch hoáº¡t. "
                "Player sá»Ÿ há»¯u sá»©c máº¡nh hoÃ n toÃ n má»›i."
            ),
            priority="critical",
            writer_instruction=(
                "Aspect Forge HOÃ€N THÃ€NH. MÃ´ táº£ cinematic moment: "
                "skill cÅ© tan biáº¿n, skill má»›i hiá»‡n ra. First use ngay trong scene. "
                "\"Báº¡n khÃ´ng cÃ²n sá»Ÿ há»¯u [tÃªn cÅ©]. Giá» báº¡n sá»Ÿ há»¯u [tÃªn má»›i].\""
            ),
            growth_context={
                "event": "aspect_forge_complete",
                "skill_name": skill.name,
                "arc_position": "3/3",
            },
        ),
    ]


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ULTIMATE SYNTHESIS ARC (3 SCENES)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def build_ultimate_beats(
    player: PlayerState,
    absorbed_skill_name: str = "",
) -> list[GrowthBeat]:
    """Build 3-beat Ultimate Synthesis narrative arc (Season Climax).

    Scene 1: "Giá»›i Háº¡n" â€” losing boss fight
    Scene 2: "Cá»™ng HÆ°á»Ÿng Tuyá»‡t Äá»‘i" â€” resonance + synthesis
    Scene 3: "TÃ¡i Sinh" â€” Ultimate first activation
    """
    skill = player.unique_skill
    if not skill:
        return []

    skill_name = skill.name
    growth = player.unique_skill_growth
    aspect = getattr(growth, "aspect_chosen", "") if growth else ""

    return [
        # â”€â”€ Scene 1: Giá»›i Háº¡n â”€â”€
        GrowthBeat(
            arc_type=GrowthArcType.ULTIMATE,
            beat_number=1,
            total_beats=3,
            scene_type="combat",
            title="Giá»›i Háº¡n",
            description=(
                "Season Climax boss, phase 3 â€” player Ä‘ang thua. "
                f"Unique Skill '{skill_name}' (Aspect: {aspect}) kÃ­ch hoáº¡t max â†’ KHÃ”NG Äá»¦. "
                f"Normal skill '{absorbed_skill_name}' cÅ©ng max â†’ KHÃ”NG Äá»¦. "
                "Hai sá»©c máº¡nh song song nhÆ°ng tÃ¡ch rá»i. Báº¡n thiáº¿u gÃ¬ Ä‘Ã³."
            ),
            priority="critical",
            writer_instruction=(
                "Season Climax moment. Player ÄANG THUA. Cáº£ Unique Skill láº«n Normal Skill "
                "Ä‘á»u Ä‘Ã£ dÃ¹ng háº¿t sá»©c â€” váº«n khÃ´ng Ä‘á»§. MÃ´ táº£ desperation, "
                "nhÆ°ng KHÃ”NG cho player cháº¿t. Táº¡o tension cho synthesis."
            ),
            growth_context={
                "event": "ultimate_limit",
                "skill_name": skill_name,
                "absorbed_skill": absorbed_skill_name,
                "arc_position": "1/3",
            },
        ),

        # â”€â”€ Scene 2: Cá»™ng HÆ°á»Ÿng Tuyá»‡t Äá»‘i â”€â”€
        GrowthBeat(
            arc_type=GrowthArcType.ULTIMATE,
            beat_number=2,
            total_beats=3,
            scene_type="combat",
            title="Cá»™ng HÆ°á»Ÿng Tuyá»‡t Äá»‘i",
            description=(
                "evolution_hint vang lÃªn láº§n cuá»‘i â€” giá»ng nÃ³i tá»« khi sinh ra táº¡i Void Between. "
                f"Unique Skill + '{absorbed_skill_name}' báº¯t Ä‘áº§u RESONANCE. "
                f"Normal skill bá»‹ ABSORB â€” biáº¿n máº¥t khá»i equipped list. "
                "AI Forge gá»i láº§n CUá»I â†’ generate Ultimate Skill. NAMING EVENT."
            ),
            priority="critical",
            writer_instruction=(
                "Synthesis moment â€” hai sá»©c máº¡nh há»£p nháº¥t. "
                f"'{absorbed_skill_name}' bá»‹ háº¥p thá»¥ vÃ o '{skill_name}'. "
                "TÃªn má»›i xuáº¥t hiá»‡n: format \"[TÃªn Skill] â€” [Danh xÆ°ng]\". "
                "Táº¥t cáº£ growth trÆ°á»›c (Echo, Scar) integrate vÃ o Ultimate."
            ),
            growth_context={
                "event": "ultimate_synthesis",
                "skill_name": skill_name,
                "absorbed_skill": absorbed_skill_name,
                "arc_position": "2/3",
            },
        ),

        # â”€â”€ Scene 3: TÃ¡i Sinh â”€â”€
        GrowthBeat(
            arc_type=GrowthArcType.ULTIMATE,
            beat_number=3,
            total_beats=3,
            scene_type="combat",
            title="TÃ¡i Sinh",
            description=(
                "Ultimate Skill kÃ­ch hoáº¡t Láº¦N Äáº¦U. "
                "Boss fight resolution â€” player tháº¯ng báº±ng Ultimate. "
                "ULTIMATE ABILITY láº§n Ä‘áº§u â€” cinematic moment kinh Ä‘iá»ƒn. "
                "Season Climax â†’ káº¿t thÃºc Season 1."
            ),
            priority="critical",
            writer_instruction=(
                "Ultimate Skill FIRST ACTIVATION. MÃ´ táº£ cinematic combat moment: "
                "skill má»›i phÃ¡t huy sá»©c máº¡nh vÆ°á»£t trá»™i. Boss bá»‹ defeated. "
                "ÄÃ¢y lÃ  peak moment cá»§a toÃ n bá»™ Season â€” make it EPIC."
            ),
            growth_context={
                "event": "ultimate_first_use",
                "skill_name": skill_name,
                "arc_position": "3/3",
            },
        ),
    ]


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ASPECT DEFER TRACKING
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

DEFER_CHAPTERS = 5  # Chapters until aspect forge re-triggers


def handle_aspect_defer(player: PlayerState) -> None:
    """Mark aspect forge as deferred. Re-triggers after 5 chapters."""
    growth = player.unique_skill_growth
    if not growth:
        return
    growth.aspect_deferred = True
    growth.aspect_defer_chapter = player.total_chapters
    logger.info(f"Aspect Forge deferred at chapter {player.total_chapters}. "
                f"Will re-trigger after {DEFER_CHAPTERS} more chapters.")


def is_aspect_defer_expired(player: PlayerState) -> bool:
    """Check if defer period (5 chapters) has passed."""
    growth = player.unique_skill_growth
    if not growth or not growth.aspect_deferred:
        return False
    return player.total_chapters >= growth.aspect_defer_chapter + DEFER_CHAPTERS


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# MAIN INTEGRATION: CHECK & INJECT
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def check_and_inject_growth_beats(
    player: PlayerState,
    growth_events: dict,
) -> list[GrowthBeat]:
    """Main entry point: check growth events and generate beats to inject.

    Called by orchestrator during chapter planning or per-scene.
    Returns list of GrowthBeats to inject into the narrative plan.

    Args:
        player: Current player state
        growth_events: Dict from update_growth_per_scene (contains
            bloom_ready, aspect_ready, ultimate_ready flags)

    Returns:
        List of GrowthBeat objects, empty if no growth event triggered.
    """
    beats: list[GrowthBeat] = []

    if not player.unique_skill or not player.unique_skill_growth:
        return beats

    # â”€â”€ Ultimate (highest priority) â”€â”€
    if growth_events.get("ultimate_ready"):
        absorbed = _find_absorbable_skill(player)
        absorbed_name = absorbed.get("name", "") if absorbed else ""
        beats = build_ultimate_beats(player, absorbed_skill_name=absorbed_name)
        logger.info(f"Injecting Ultimate Synthesis arc ({len(beats)} beats)")
        return beats  # Ultimate takes over the entire chapter

    # â”€â”€ Aspect Forge â”€â”€
    if growth_events.get("aspect_ready"):
        # Check if deferred and still waiting
        growth = player.unique_skill_growth
        if growth.aspect_deferred and not is_aspect_defer_expired(player):
            logger.info(
                f"Aspect Forge still deferred "
                f"({player.total_chapters - growth.aspect_defer_chapter}/{DEFER_CHAPTERS} chapters)"
            )
            return beats  # Still waiting

        beats = build_aspect_forge_beats(player)
        logger.info(f"Injecting Aspect Forge arc ({len(beats)} beats)")
        return beats  # Aspect takes full chapter

    # â”€â”€ Bloom (Echo / Scar) â”€â”€
    bloom_trigger = growth_events.get("bloom_ready")
    if bloom_trigger:
        beats = build_bloom_beats(player, bloom_trigger)
        logger.info(f"Injecting Bloom beats ({len(beats)} beats)")
        return beats

    return beats


def build_growth_writer_context(player: PlayerState) -> dict:
    """Build growth context for SceneWriter.

    Provides Writer with current growth state data for accurate
    skill descriptions. Always included when player has unique skill.
    """
    skill = player.unique_skill
    growth = player.unique_skill_growth
    if not skill or not growth:
        return {}

    return {
        "unique_skill": {
            "name": skill.name,
            "mechanic": skill.mechanic,
            "category": skill.category,
        },
        "growth_state": {
            "type": growth.active_growth.value if hasattr(growth.active_growth, "value") else str(growth.active_growth),
            "current_stage": growth.current_stage,
            "echo_coherence_streak": growth.echo_coherence_streak,
            "scar_type": growth.scar_type.value if growth.scar_type and hasattr(growth.scar_type, "value") else None,
            "aspect": growth.aspect_chosen if growth.aspect_forged else None,
            "ultimate": bool(growth.ultimate_forged),
            "bloom_completed": growth.bloom_completed,
        },
        "instruction": (
            f"MÃ´ táº£ unique skill '{skill.name}' á»Ÿ dáº¡ng hiá»‡n táº¡i. "
            f"Growth stage: {growth.current_stage}. "
            "Skill pháº£n Ã¡nh hÃ nh trÃ¬nh player â€” khÃ´ng generic."
        ),
    }


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# HELPERS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def _find_absorbable_skill(player: PlayerState) -> dict | None:
    """Find a normal skill that can be absorbed for Ultimate Synthesis.

    Requirements (from GROWTH_SPEC Â§7.2):
    - Not the unique skill itself
    - Refined (in progression.refinements_done)
    - Same principle as unique skill
    """
    if not player.unique_skill:
        return None

    unique_traits = set(player.unique_skill.trait_tags or [])
    refinements = set(getattr(player.progression, "refinements_done", []))

    for s in player.equipped_skills:
        if not isinstance(s, dict):
            continue
        skill_id = s.get("id", s.get("name", ""))
        if skill_id == player.unique_skill.name:
            continue  # Skip unique skill itself
        principle = s.get("primary_principle", "")
        if skill_id in refinements and principle in unique_traits:
            return s

    # Fallback: take first equipped normal skill if any
    for s in player.equipped_skills:
        if isinstance(s, dict) and s.get("name", "") != player.unique_skill.name:
            return s

    return None

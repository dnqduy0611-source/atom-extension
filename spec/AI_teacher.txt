Dưới đây là **spec cụ thể (v1)** cho hướng **AI làm chủ đạo (teacher) để phân biệt Doomscroll vs Intentional Reading (đọc thật vì tò mò/học hỏi/tra cứu/giải trí có chủ đích)**, đồng thời ATOM **đối chiếu + log** để sau này **tự học và build model riêng**.

Mình viết theo kiểu bạn có thể đưa thẳng cho Codex/CLI triển khai vào **ATOM Extension V5.7**.

---

# ATOM AI-Pilot Mode v1 Spec (Accuracy-first)

## 0) Mục tiêu

1. Phân loại trạng thái người dùng theo 2 trục:

* `intent_score` (0–1): mức “đọc có chủ đích / muốn hiểu / thích thú thật”
* `compulsion_score` (0–1): mức “lướt vô thức / dopamine loop”

2. Từ đó suy ra `mode`:

* `intentional` (đọc thật)
* `mixed` (vừa đọc thật vừa có dấu lún)
* `doomscroll` (lướt vô thức)

3. AI (LLM) **chủ đạo** trong các trường hợp “khó”, còn ATOM rule-based làm **guardrail** (Focus mode, cooldown, chống lag/cost, fallback khi AI lỗi).

4. Log “AI vs Rule vs User reaction” để tạo dataset distillation.

---

## 1) Non-goals (không làm trong v1)

* Không train model riêng ngay trong extension.
* Không gửi toàn bộ nội dung trang lên cloud (chỉ gửi **snippet giới hạn**).
* Không cố nhận diện cảm xúc sâu/nhạy cảm bằng nội dung riêng tư.
* Không can thiệp kiểu “đọc bài này đúng/sai” (ATOM chỉ can thiệp hành vi).

---

# 2) Kiến trúc tổng quan

## 2.1 Luồng quyết định

**Content.js** → tạo `observation_frame_v2` → gửi lên **Background.js**
**Background.js**:

1. Guardrails (Focus/whitelist/system urls/cooldowns)
2. Nếu cần: gọi **AI Proxy** `/decide` để lấy `ai_decision`
3. Merge với rule-decision → `final_decision`
4. Send to tab để render (presence/micro/gentle/hard)
5. Log: `atom_ai_pilot_logs`

## 2.2 Quy tắc “AI chủ đạo” nhưng có hàng rào

* AI được quyền quyết định **mode + recommend** khi:

  * không vi phạm Focus hard rules
  * đủ điều kiện gọi (gating)
  * kết quả `confidence` đạt ngưỡng
* Rule thắng khi:

  * Focus WORK + domain bị block + allow hết hạn
  * AI timeout/lỗi/format sai
  * vượt quota/rate limit
  * privacy policy chặn (ví dụ trang banking/medical portal… nếu bạn muốn)

---

# 3) Data Spec: Observation Frame v2 (tối ưu cho accuracy)

## 3.1 Schema (JSON)

```json
{
  "v": 2,
  "ts": 0,
  "tabId": 0,

  "page": {
    "url": "",
    "domain": "",
    "path": "",
    "title": "",
    "lang": "vi|en|...",
    "pageType": "feed|article|forum|doc|pdf|video|unknown",
    "isInfiniteScrollLikely": false,
    "hasVideoLikely": false,
    "wordCountApprox": 0,
    "headingSample": ["", ""]
  },

  "snippet": {
    "viewportText": "",
    "viewportTextChars": 0,
    "selectedText": "",
    "selectedTextChars": 0
  },

  "behavior_60s": {
    "dwellMeanMs": 0,
    "dwellP90Ms": 0,
    "scrollPxTotal": 0,
    "scrollPxPerSec": 0,
    "continuousScrollSec": 0,
    "directionChanges": 0,
    "scrollBackEvents": 0,
    "idleSec": 0
  },

  "actions_60s": {
    "selectCount": 0,
    "copyCount": 0,
    "findCount": 0,
    "openLinkCount": 0,
    "backForwardCount": 0,
    "typingCount": 0
  },

  "state": {
    "focusEnabled": false,
    "focusPhase": "WORK|BREAK|null",
    "focusAllowRemainingSec": 0,
    "atomSensitivity": "gentle|balanced|strict",
    "lastInterventionType": "none|presence|micro|gentle|hard",
    "lastInterventionAgoSec": 0,
    "resistanceScore": 0
  }
}
```

## 3.2 Cách lấy dữ liệu (implementation notes)

* `title`, `headingSample`: lấy H1/H2 (tối đa 6 cái, cắt 80 ký tự/cái)
* `viewportText`: lấy text “đang nhìn thấy”

  * giới hạn **1000–1500 ký tự**
  * lọc bỏ text từ `<input>`, `<textarea>`, contenteditable
  * bỏ các đoạn có pattern nhạy cảm đơn giản (OTP, số thẻ dài…) nếu muốn
* `selectedText`: nếu user đang highlight, lấy tối đa **300–500 ký tự**
* `pageType` heuristic:

  * `article`: có `<article>` hoặc density text cao + headings
  * `feed`: nhiều card lặp + scroll height tăng + ít text dài
  * `forum`: nhiều comment nodes
  * `video`: domain video/shorts hoặc video player
  * `pdf`: detect pdf viewer/url endswith .pdf
* `actions_60s`: bắt event `copy`, `keydown (Ctrl+F)`, `click a`, `popstate`, `selectionchange`

---

# 4) AI Decision Spec

## 4.1 API Contract (Proxy)

**POST** `/decide`

Request:

```json
{
  "client": { "app": "ATOM", "ver": "5.7", "pilot": "v1" },
  "frame": { ...observation_frame_v2... }
}
```

Response (bắt buộc):

```json
{
  "intent_score": 0.0,
  "compulsion_score": 0.0,
  "mode": "intentional|mixed|doomscroll",
  "confidence": 0.0,

  "recommend": "none|presence|micro|gentle|hard",
  "hard_mode": "BREATH|TAP|STILLNESS|null",
  "cooldown_s": 0,

  "why_short": ""
}
```

## 4.2 Prompt rules (LLM)

* **System**: “Trả JSON đúng schema, không giải thích dài”
* **User**: đưa `pageType`, `title`, `headingSample`, `viewportText`, `behavior_60s`, `actions_60s`, `focus state`
* Quy ước:

  * `intent_score` tăng nếu: dwell sâu, scroll-back, select/copy/find/open link có mục tiêu, nội dung dạng bài dài/hướng dẫn/phân tích
  * `compulsion_score` tăng nếu: continuous scroll dài, dwell ngắn lặp, feed/shorts, ít hành động chủ động
  * `mixed` khi cả hai đều cao (ví dụ: đọc thích thú nhưng đang bị feed kéo)
* `recommend` theo mode:

  * intentional → none/presence
  * mixed → presence/gentle
  * doomscroll → micro/hard (tuỳ focus/resistance/cooldown)
* `confidence` thấp khi text quá ít, pageType unknown, tín hiệu mâu thuẫn.

## 4.3 Validation (bắt buộc)

Background phải validate:

* JSON parse ok
* đủ keys
* score trong [0,1]
* enum hợp lệ
* `cooldown_s` trong [0, 120] (cap)
* `why_short` <= 140 chars
  Nếu fail → fallback rule.

---

# 5) Gating & Cost Control (cốt lõi để không cháy tiền)

## 5.1 Khi nào gọi AI?

Gọi AI khi **một trong các điều kiện**:

1. `zone` theo rule là **yellow/red** (đang nghi ngờ doomscroll)
2. `pageType` là **khó phân biệt**: `forum|doc|pdf|article dài`
3. “tín hiệu chủ động” xuất hiện nhưng scroll pattern giống doomscroll:

   * `selectCount+findCount+copyCount >= 1` AND `continuousScrollSec` cao
4. chuẩn bị escalate lên `hard_interrupt` (để tránh đập nhầm)

## 5.2 Khi nào KHÔNG gọi AI?

* Focus WORK + domain bị block + allow hết hạn → enforce ngay
* Tab/system url
* `aiCooldownUntil > now` (cooldown chung)
* `perTabCache` còn hạn (TTL 10–20s)
* `dailyBudgetUsed >= dailyBudgetCap`
* `frame.snippet.viewportTextChars < 200` và không có selectedText → thường confidence thấp, bỏ qua (tùy chọn)

## 5.3 Cache

* `aiDecisionCacheByTab[tabId] = { decision, expiresAt }`
* TTL mặc định: 15s
* Nếu AI trả `cooldown_s` > 0 thì set `aiCooldownUntil = now + cooldown_s`

---

# 6) Merge Logic (AI chủ đạo nhưng có guardrail)

## 6.1 Rule-decision vẫn tạo “baseline”

Rule (existing pipeline) vẫn quyết định:

* zone: green/yellow/red
* candidate intervention: presence/micro/gentle/hard
* hard cooldown, resistance score…

## 6.2 Quy tắc merge

1. Nếu **Guardrail hard-block** (Focus WORK + blocked + no allow):
   → `final = hard_interrupt (FOCUS_BLOCK_UI)` (không hỏi AI)

2. Else nếu có `ai_decision` hợp lệ:

* Nếu `ai.confidence >= 0.65`: **ưu tiên ai.recommend**
* Nếu `0.45 <= confidence < 0.65`: dùng ai để **điều chỉnh mức can thiệp** (vd rule hard → xuống micro nếu ai nói intentional/mixed)
* Nếu `< 0.45`: bỏ ai, dùng rule

3. Mức can thiệp không được vượt guardrail:

* nếu đang cooldown hard: không được hard
* nếu user_sensitivity = gentle: hard chỉ khi focus/vi phạm nặng

## 6.3 Mapping từ scores → mode (nếu cần normalize)

Nếu AI chỉ trả scores mà mode sai, ATOM có thể tự chuẩn hoá:

* doomscroll: `compulsion >= 0.75 && intent <= 0.35`
* intentional: `intent >= 0.65 && compulsion <= 0.55`
* else mixed

---

# 7) Intervention Policy (đúng triết lý “không phạt đọc vì thích”)

* **intentional**:

  * mặc định `none`
  * nếu quá lâu + focus enabled: `presence` check-in nhẹ

* **mixed**:

  * `presence` hoặc `gentle_reflection`
  * copy gợi ý: “Bạn đang đọc vì tò mò hay đang bị feed kéo?”

* **doomscroll**:

  * `micro_closure` trước
  * nếu resistance cao + cooldown ok: `hard_interrupt`

---

# 8) Storage Keys (chrome.storage.local)

## 8.1 Config

* `atom_ai_pilot_enabled`: boolean (default false)
* `atom_ai_pilot_mode`: `"shadow" | "assist" | "primary"`

  * shadow: AI chỉ log
  * assist: AI gợi ý, rule quyết định
  * primary: AI quyết định trong phạm vi guardrail
* `atom_ai_pilot_accuracy_level`: `"balanced" | "high"` (high gửi viewportText/headings)
* `atom_ai_proxy_url`: string
* `atom_ai_budget_daily_cap`: number (requests/day hoặc tokens/day)
* `atom_ai_confidence_threshold_primary`: number (default 0.65)
* `atom_ai_cache_ttl_ms`: number (default 15000)

## 8.2 Runtime

* `atom_ai_budget_state`: { dayKey, usedCount }
* `atom_ai_cooldown_until`: timestamp

## 8.3 Logs

* `atom_ai_pilot_logs_v1`: array (ring buffer) hoặc JSONL chunk

  * cap 500–2000 entries, rollover

---

# 9) Logging Spec (để distill model riêng)

Mỗi tick có AI gọi hoặc có can thiệp:

```json
{
  "ts": 0,
  "tabId": 0,
  "domain": "",
  "pageType": "",

  "frame_digest": {
    "behavior_60s": { ... },
    "actions_60s": { ... },
    "title_hash": "",
    "snippet_hash": ""
  },

  "rule": { "zone": "", "suggest": "", "reason_codes": [] },
  "ai": { "mode": "", "intent": 0, "compulsion": 0, "recommend": "", "confidence": 0, "latency_ms": 0 },
  "final": { "intervention": "", "hard_mode": null, "source": "rule|ai|guardrail" },

  "reaction_later": {
    "within_sec": 30,
    "user_action": "ignored|dismissed|snoozed|stopped|allowed|none"
  }
}
```

> Lưu ý: log chỉ cần **hash** cho text (để privacy) nhưng vẫn giữ được thống kê. Nếu bạn muốn train supervised sau này bằng text thì phải có chính sách riêng; v1 nên hash.

---

# 10) Thay đổi file-level (gắn vào ATOM V5.7)

## 10.1 content.js

* [NEW] `collectViewportText()` (giới hạn chars, filter input)
* [NEW] track `select/copy/find/openLink/backForward/typing`
* [MOD] gửi `OBS_FRAME_V2` lên background theo tick hoặc khi “state change”

## 10.2 background.js

* [NEW] `shouldCallAI(frame, ruleState)` gating
* [NEW] cache per tab + global cooldown + budget
* [MOD] integrate `ai_service.js` → gọi proxy `/decide`
* [NEW] `mergeDecision(ruleDecision, aiDecision)` theo mục 6
* [NEW] log writer `appendAiPilotLog(entry)`

## 10.3 ai_service.js

* [MOD] thêm function `decideViaProxy(frame)` (timeout 300–800ms)
* [MOD] chuẩn hoá output + validation helper

## 10.4 strategy_layer.js / selection_logic.js

* [MOD nhẹ] cho phép “AI override suggestion” trong mode assist/primary
* [MOD nhẹ] mapping recommend → intervention payload

---

# 11) UX: Không làm user khó chịu

* Khi `mode=intentional`: gần như im lặng
* Khi `mixed`: copy kiểu “check-in” chứ không phán xét
* Khi `doomscroll`: can thiệp theo escalation hiện có

---

# 12) Test Plan (tối thiểu)

1. Case intentional:

* bài blog dài, scroll chậm, select/copy → AI intentional, no intervention

2. Case doomscroll:

* feed infinite, scroll liên tục, dwell ngắn → AI doomscroll, micro/hard

3. Case mixed:

* đọc thread dài nhưng bị kéo liên tục → AI mixed, gentle

4. Focus guardrail:

* Focus WORK + blocked domain → luôn block ngay, AI không được override

5. Timeout/fail JSON:

* AI lỗi → fallback rule

6. Budget exhausted:

* không gọi AI nữa, vẫn dùng rule



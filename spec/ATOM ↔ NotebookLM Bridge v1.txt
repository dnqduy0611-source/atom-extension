Dưới đây là **spec “ATOM ↔ NotebookLM Bridge v1”** theo đúng phân vai 5 mảng bạn đã chốt (ATOM điều phối + lọc; Gemini cho “micro-cognition”; NotebookLM cho “storage/recall/deep reasoning”). Mình viết theo kiểu bạn có thể đưa thẳng cho Codex/CLI triển khai dần.

> Lưu ý về nền tảng: hiện có **API chính thức cho NotebookLM Enterprise** (tạo notebook, thêm sources, upload file, audio overview…), yêu cầu setup + license. ([Google Cloud Documentation][1])
> Với NotebookLM bản consumer (notebooklm.google), thường **không có API chính thức**, nên Bridge v1 phải có **chế độ “UI-assisted”** (mở tab + clipboard + user confirm). Ngoài ra có các hướng “unofficial automation/MCP server” (tùy chọn về sau). ([GitHub][2])

---

## 0) Tên & Mục tiêu

**Tên:** ATOM ↔ NotebookLM Bridge v1 (NLM Bridge v1)

**Mục tiêu (đúng phân vai 5 mảng):**

1. **Storage (NotebookLM chủ đạo):** biến “Active Reading traces” của ATOM thành **nguồn tri thức có tổ chức** trong NotebookLM (theo project/topic).
2. **Recall/Retrieval (NotebookLM chủ đạo):** mở đúng notebook & context để user hỏi/tra cứu trong NotebookLM nhanh hơn.
3. **Idea Incubator (NotebookLM + Gemini, ATOM điều phối):** khi ATOM phát hiện “cluster đọc” theo chủ đề → gợi ý tạo notebook/project và đẩy bundle.
4. **Thinking Assistant & Weekly Digest (Gemini chủ đạo):** Bridge chỉ **đẩy kết quả digest/insight** sang NotebookLM nếu user muốn lưu; NotebookLM không tham gia “thinking loop” thời gian thực.

**Không thay đổi vai trò:**

* **ATOM**: gatekeeper, quyết định cái gì đáng nhớ, không nhồi full page.
* **Gemini**: phản xạ ngắn (clarify/rewrite/tag/digest), không làm storage.
* **NotebookLM**: kho + reasoning trên sources đã lưu.

---

## 1) Phạm vi (Scope)

### In-scope (v1)

A. **Export “Reading Bundle”** (từ Active Reading) sang NotebookLM theo notebook đích.
B. **Mapping “Project/Topic → Notebook”** (rule-based + user override).
C. **Queue + dedupe + retry** (MV3-safe) để không mất dữ liệu.
D. **Open-to-Recall:** từ ATOM “Memory” mở đúng notebook (và gợi ý câu hỏi/clipboard).
E. **Idea Incubator trigger:** khi đủ “cluster” → đề xuất tạo notebook mới (UI-assisted hoặc Enterprise API).

### Out-of-scope (v1)

* Không cố “chat/ask” programmatically với NotebookLM (Enterprise API hiện thiên về quản lý notebook + sources + audio overview, chưa phải chat API công khai). ([Google Cloud Documentation][1])
* Không tự động “scrape full article” để đưa vào NotebookLM.
* Không đồng bộ hai chiều (NotebookLM → ATOM) ở v1.

---

## 2) Hai chế độ Bridge (bắt buộc để v1 chạy được cho mọi người)

### Mode 1 — UI-Assisted (Default, chạy với NotebookLM consumer)

**Ý tưởng:** ATOM chuẩn bị gói dữ liệu → **copy clipboard** + **mở NotebookLM** đúng notebook → user **dán/confirm**.

* Ưu: không cần API, không đụng auth phức tạp.
* Nhược: cần 1 bước xác nhận.

### Mode 2 — Enterprise API (Optional, nếu user có NotebookLM Enterprise)

ATOM gọi API để:

* tạo notebook, lấy notebookId, list recently viewed… ([Google Cloud Documentation][1])
* thêm sources: URL/webContent, raw text, upload file… ([Google Cloud Documentation][3])
* (tùy chọn) tạo audio overview theo focus… ([Google Cloud Documentation][4])

> Spec v1 vẫn thiết kế interface để sau này “swap connector” (UI-assisted ↔ Enterprise API) mà không đổi business logic.

---

## 3) Data Model: “Reading Bundle” (đơn vị xuất sang NotebookLM)

### 3.1. ReadingBundle (nội bộ ATOM)

```ts
type ReadingBundle = {
  id: string;                  // atom_trace_id
  url: string;
  title?: string;
  domain?: string;

  capturedAt: number;          // epoch ms
  readingMode: "skim" | "deep" | "reference" | "reread";
  confidence: number;          // từ heuristic/AI (>= min threshold)

  selectedText?: string;       // đã cắt theo selectedMaxChars
  viewportExcerpt?: string;    // đã cắt theo viewportMaxChars

  userIntentLabel?: "work"|"research"|"reference"|"curiosity"|null; // nếu user confirm
  atomicThought?: string;      // 1 câu insight (optional)
  tags?: string[];             // gợi ý bởi Gemini + user confirm

  sourceType: "web" | "text_only";
  privacy: {
    containsPII: boolean;      // heuristic detect (email/phone/etc)
    allowCloudExport: boolean; // toggle user
  };
}
```

### 3.2. NotebookLM Export Payload (markdown text source)

**Chuẩn hoá thành 1 “ATOM Clip”** để NotebookLM đọc tốt, có context rõ:

**ATOM Clip Template (Markdown):**

* Title: `ATOM Clip — {title}`
* Source URL: `{url}`
* CapturedAt: `{ISO time}`
* Mode/Confidence
* Intent (nếu có)
* Tags
* Highlight (selectedText) hoặc Excerpt
* Atomic Thought (nếu có)
* “Why saved” (1 dòng micro-reflection, optional)

> Quy tắc: **không bao giờ** đưa full page. Chỉ đưa “dấu vết” + snippet.

---

## 4) Mapping: Project/Topic → Notebook

### 4.1. NotebookTargetRule

```ts
type NotebookTargetRule =
  | { kind: "default"; notebookRef: string }  // notebook name hoặc enterprise notebookId
  | { kind: "byDomain"; domain: string; notebookRef: string }
  | { kind: "byTag"; tag: string; notebookRef: string }
  | { kind: "byIntent"; intent: string; notebookRef: string };
```

### 4.2. Quy tắc chọn notebook (priority)

1. byTag (user-confirm tags)
2. byIntent
3. byDomain
4. default (“Inbox”)

**Inbox notebook** là bắt buộc để không “rơi dữ liệu”.

---

## 5) Luồng nghiệp vụ (đúng 5 mảng)

### 5.1. Mảng 1 — Storage: “Save to NotebookLM”

**Trigger:** user bôi đen / deep-read event + confidence đủ + user bấm Save (hoặc auto-save nếu bật).

**Steps:**

1. ATOM tạo `ReadingBundle` (đã truncate, đã privacy check).
2. Chọn `NotebookTargetRule` → `notebookRef`.
3. Push vào `ExportQueue` (storage.local).
4. Thực thi theo connector:

   * UI-Assisted: copy `ATOM Clip` → mở NotebookLM notebook → show toast “Đã copy, dán vào Sources”.
   * Enterprise: gọi `notebooks.sources.batchCreate` với:

     * `webContent(url, sourceName)`
     * `textContent(sourceName, ATOM Clip)` ([Google Cloud Documentation][3])

**Definition of Done (v1):**

* User thao tác ≤ 2 click để clip nằm trong notebook đúng.

---

### 5.2. Mảng 2 — Thinking Assistant (Gemini): “Không nằm trong Bridge”

Bridge **không** gọi NotebookLM để “nghĩ”.
Nhưng Bridge có 1 endpoint nội bộ:

**“Export Thought-only”**

* Khi Gemini giúp rewrite/tag/clarify/atomic-thought → user có thể “Save insight to NotebookLM” như 1 `textContent`.

> NotebookLM chỉ nhận kết quả cuối để lưu, không tham gia loop.

---

### 5.3. Mảng 3 — Recall & Retrieval: “Open to Recall”

**Trigger:** user tìm lại trong ATOM Memory (search/tag/time) và muốn “hỏi sâu”.

**Steps:**

1. ATOM hiển thị list “đã export sang notebook nào”.
2. Button: **Open NotebookLM** (mở đúng notebookRef).
3. Optional: button **Copy question** (gợi ý câu hỏi dựa trên bundle + tags) để user paste vào chat NotebookLM.

**v1 không cần** auto-inject câu hỏi vào NotebookLM UI (đỡ rủi ro MV3/host permissions). Có thể làm v1.1.

---

### 5.4. Mảng 4 — Weekly/Project Digest (Gemini chủ đạo)

**Trigger:** mỗi tuần / theo project.

**Steps:**

1. Gemini tạo digest từ atomic thoughts/traces (local).
2. User bấm “Save digest to NotebookLM”.
3. Bridge export digest như `textContent` vào notebook “Project” hoặc “Digest”.

**Không làm:** NotebookLM generate digest cho ATOM.

---

### 5.5. Mảng 5 — Idea Incubator

**Trigger heuristic:** trong 7 ngày có:

* ≥ N bundles cùng tag/topic
* reread cao
* dwell time cao

**Flow:**

1. ATOM prompt: “Bạn có vẻ đang gom ý quanh X. Tạo notebook ‘X’ không?”
2. Nếu đồng ý:

   * UI-Assisted: mở NotebookLM trang tạo notebook (user tạo) rồi quay lại ATOM chọn notebookRef.
   * Enterprise: gọi `notebooks.create` để tạo, lấy `notebookId`. ([Google Cloud Documentation][1])
3. Batch export các bundle liên quan vào notebook mới:

   * Enterprise: `sources.batchCreate` web+text. ([Google Cloud Documentation][3])

**Optional (Enterprise-only, v1.1):**

* tạo audio overview với `episodeFocus` theo chủ đề X. ([Google Cloud Documentation][4])

---

## 6) ExportQueue, Dedupe, Retry (MV3-friendly)

### 6.1. Queue item

```ts
type ExportJob = {
  jobId: string;
  bundleId: string;
  notebookRef: string;
  mode: "ui_assisted" | "enterprise";
  status: "queued"|"running"|"success"|"failed";
  attempts: number;
  lastError?: string;
  createdAt: number;
}
```

### 6.2. Dedupe key

`dedupeKey = sha256(url + selectedTextHash + dayBucket + notebookRef)`

Nếu trùng trong 24h → hỏi user “lưu lại hay bỏ”.

### 6.3. Retry policy

* Max attempts: 3
* Backoff: 5s → 30s → 2m
* Nếu UI-assisted: retry chỉ là “nhắc lại thao tác”, không tự chạy nền.

---

## 7) Privacy & Guardrails (bắt buộc)

1. **Opt-in cloud export** (toggle).
2. **PII heuristic**: email/phone/ID-like patterns → cảnh báo trước khi export.
3. **Char limits**: exportMaxChars riêng cho NotebookLM Clip (không vượt quá selectedMaxChars nhiều).
4. Không gửi content nếu:

   * confidence < min threshold
   * source là “sensitive domain” user định nghĩa (hospital EMR, nội bộ…).

---

## 8) Options UI (v1)

**NotebookLM Bridge**

* Enable toggle
* Mode: UI-Assisted / Enterprise API
* Default notebookRef (“Inbox”)
* Rules:

  * byTag mapping
  * byDomain mapping
  * byIntent mapping
* Export format:

  * URL only
  * Clip markdown
  * Clip + URL (khuyến nghị)
* Privacy:

  * allowCloudExport
  * piiWarning toggle

**Enterprise section (chỉ hiện nếu chọn Enterprise mode)**

* projectNumber
* location (global/us/eu)
* notebooklm.cloud.google.com base
* connect account (OAuth)

> Gợi ý kỹ thuật: enterprise docs yêu cầu setup/licensing và dùng access token; spec này chỉ định mức “cần OAuth token”, không bắt bạn implement ngay. ([Google Cloud Documentation][1])

---

## 9) Logging & Observability

Các event journal:

* `nlm_bridge.export_attempt`
* `nlm_bridge.export_success`
* `nlm_bridge.export_failed` (errorCode)
* `nlm_bridge.open_to_recall`
* `nlm_bridge.idea_incubator_created`

Metrics tối thiểu:

* success rate / mode
* average clicks-to-save
* bundle dropout reason (PII blocked, too long, user canceled)

---

## 10) Acceptance Criteria (v1)

1. User có thể **lưu một highlight/insight** vào NotebookLM trong ≤ 2 thao tác (UI-assisted).
2. Có “Inbox notebook” làm default, **không rơi dữ liệu**.
3. Dedupe hoạt động, không spam NotebookLM.
4. Từ ATOM Memory, user **mở đúng notebook** trong 1 click (Open-to-Recall).
5. Bridge không làm sai vai trò: không dùng NotebookLM cho thinking loop, không lưu full page.

---

## 11) Roadmap sau v1 (để bạn không bị “kẹt”)

* v1.1: (Enterprise) batch export web+text + audio overview theo focus. ([Google Cloud Documentation][3])
* v1.2: optional “MCP connector” cho power user (unofficial) để tự động hoá hơn, nhưng tách riêng vì rủi ro/độ bền. ([GitHub][2])
* v1.3: bi-directional “index only” (kéo metadata sources về ATOM để search tốt hơn).

---

Nếu bạn đồng ý, bước tiếp theo mình sẽ làm luôn (không hỏi lại):

1. **Vẽ sequence diagram** cho 3 flow quan trọng: Save → Queue → UI-assisted; Open-to-Recall; Idea Incubator.
2. Đề xuất **file/module layout** trong MV3 (connector interface + queue manager + options wiring) để bạn nhét vào codebase ATOM hiện tại thật gọn.

[1]: https://docs.cloud.google.com/gemini/enterprise/notebooklm-enterprise/docs/api-notebooks "Create and manage notebooks (API)  |  NotebookLM Enterprise  |  Google Cloud Documentation"
[2]: https://github.com/PleasePrompto/notebooklm-mcp?utm_source=chatgpt.com "PleasePrompto/notebooklm-mcp"
[3]: https://docs.cloud.google.com/gemini/enterprise/notebooklm-enterprise/docs/api-notebooks-sources "Add and manage data sources in a notebook (API)  |  NotebookLM Enterprise  |  Google Cloud Documentation"
[4]: https://docs.cloud.google.com/gemini/enterprise/notebooklm-enterprise/docs/api-audio-overview "Manage audio overview of your notebook (API)  |  NotebookLM Enterprise  |  Google Cloud Documentation"

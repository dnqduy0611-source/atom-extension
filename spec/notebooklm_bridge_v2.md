# NotebookLM Bridge V2 Specification

> **Version:** 2.0
> **Status:** Draft
> **Last Updated:** 2026-02-03

## 1. Overview
The **NotebookLM Bridge** connects the browser extension (ATOM) with Google's NotebookLM. 
**Version 2** improves upon the original by introducing AI-driven naming, rich data transfer, and a more robust re-findability mechanism.

## 2. Core Philosophy: Identity vs. Presentation
To solve the "Re-findability" problem while providing "Smart Naming", we strictly separate the **Identity** of a topic from its **Presentation**.

| Concept | Field | Generated By | Purpose | Characteristics |
| :--- | :--- | :--- | :--- | :--- |
| **Identity** | `topicKey` | **Algorithm** (Regex/Keywords) | Finding appropriate notebooks for future content | Deterministic, Mutable only by merge |
| **Presentation** | `displayTitle` | **AI** (Gemini Flash) | Human-readable label for the UI & Notebook Name | Creative, Non-deterministic, Editable |

> **Key Rule:** We NEVER change the `topicKey` based on the AI title. The `topicKey` must remain algorithmic (e.g., `kw:quantum-physics`) so that future visits to similar pages (which generate the same algorithmic key) can successfully match against the registry.

## 3. Data Structures

### 3.1 Topic Registry Entry (`TopicEntry`)
Stored in `bridge/topic_registry.js`.

```typescript
interface TopicEntry {
  // Identity (Immutable-ish)
  topicKey: string;       // e.g. "kw:quantum-physics" (Algorithmic)
  
  // Presentation (Mutable)
  displayTitle: string;   // e.g. "Quantum Mechanics Basics" (AI Generated)
  
  // Target
  notebookRef: string;    // NotebookLM ID (e.g. "d1234567")
  notebookUrl: string;    // Full URL
  
  // Metadata
  keywords: string[];     // e.g. ["quantum", "physics", "entanglement"]
  source: "generated" | "manual";
  usageCount: number;
  lastUsedAt: number;     // Timestamp
}
```

### 3.2 Rich Data Clip (`AtomClip`)
The payload manually pasted by the user. Formatted as Markdown.

```markdown
# ATOM Clip - [Title]

- Source URL: [URL]
- CapturedAt: [ISO Date]
- Mode: [Reading Mode]

## Highlight
[Selected Text]

## Atomic Thought
[User's Note if any]

## Refined Insight
[AI Analysis if any]
```

## 4. Workflows

### 4.1 Topic Extraction & Routing
**File:** `bridge/topic_router.js`

1.  **Extract:** `topic_extractor.js` analyzes page content -> returns `extractedTopic` (Key: `kw:quantum-physics`).
2.  **Match:** `topic_scoring.js` compares `extractedTopic.topicKey` vs Registry. 
    - _Crucial:_ Matches against `entry.topicKey`, NOT `entry.displayTitle`.
3.  **Decision:**
    - **Match Found (>70%):** Return `use_existing`. Prompt user to save to "Quantum Mechanics Basics" (Display Title).
    - **No Match:** Return `create`. 
        - **Trigger AI:** Call `AI_SERVICE.generateTitle(selection)` -> "Quantum Mechanics Basics".
        - **Pass to UI:** Show "Create new notebook: **Quantum Mechanics Basics**".
        - **Preserve Key:** Keep `topicKey` as `kw:quantum-physics` in the Pending Topic.

### 4.2 Creation & Mapping
**File:** `bridge/nlm_passive_learning.js`

1.  **User Action:** User agrees to create.
2.  **Redirect:** ATOM opens NotebookLM.
3.  **Pending State:** Background holds `PendingTopic` { key: `kw:quantum-physics`, title: "Quantum..." }.
4.  **Detection:** Content script detects user created a notebook with ID `d123`.
5.  **Prompt:** UI asks "Map **Quantum Mechanics Basics** to this notebook?".
6.  **Save:** User confirms.
    - Registry saves: `key: kw:quantum-physics` -> `ref: d123`.
    - Display Title: "Quantum Mechanics Basics".

### 4.3 Content Transfer (The "Coach")
**File:** `bridge/topic_router_handlers.js` & `nlm_passive_learning.js`

1.  **Payload Generation:** `handleCreateNew` generates `AtomClip` markdown using `formatAtomClip`.
2.  **Clipboard:** `nlm_passive_learning` copies this Markdown to clipboard.
3.  **Guide:** 3-Step UI appears on NotebookLM:
    1.  Click "Add Source" (Button highlighted via CSS).
    2.  Select "Copied Text".
    3.  Paste.

## 5. UI/UX Specifications

### 5.1 Passive Learning Prompt
- **Location:** NotebookLM interface (Bottom Right).
- **Elements:**
    - **Header:** "Save this mapping?"
    - **Map Viz:** `Topic Name` -> `Notebook Name`.
    - **Guide:** 3-Step Paste Instructions.
    - **Actions:** "Yes, Remember", "No Thanks", "Copy Text", "Copy Link".
- **Interaction:**
    - **Auto-Copy:** Text copied on load.
    - **Blink:** "Add Source" button pulses purple.

## 6. Future Considerations
- **Sync:** If user renames notebook in NotebookLM, we technically don't know unless we scrape it again.
- **Write API:** If Google releases a NotebookLM Write API, we replace the "Coach" with direct injection.
